<!DOCTYPE html>
<html lang="de" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TwitchTools ‚Äì Besser als tools.2807.eu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            twitch: {
              purple: '#9146FF',
              dark: '#0F0F23',
              darker: '#0A0A1A',
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-twitch-darker text-white min-h-screen">
  <div class="container mx-auto p-6 max-w-6xl">
    <header class="text-center mb-12">
      <h1 class="text-5xl font-bold bg-gradient-to-r from-twitch-purple to-purple-600 bg-clip-text text-transparent">
        TwitchTools
      </h1>
      <p class="text-xl text-purple-300 mt-2">Besser als tools.2807.eu ‚Äì mit Profilbildern, Suchfeld & Dark Mode</p>

      <!-- Dark/Light Toggle -->
      <button id="theme-toggle" class="mt-4 px-6 py-3 bg-twitch-purple rounded-xl hover:bg-purple-800 transition">
        Light Mode
      </button>
    </header>

    <!-- Tool Grid -->
    <div id="mainTools" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
      <div class="bg-twitch-dark p-8 rounded-2xl shadow-xl hover:shadow-purple-500/40 transition cursor-pointer" onclick="loadTool('follows')">
        <div class="text-6xl mb-4">üë•</div>
        <h2 class="text-2xl font-bold mb-2">Follows</h2>
        <p class="text-purple-300">Wer folgt wem ‚Äì mit Datum & Profilbild</p>
      </div>
      <div class="bg-twitch-dark p-8 rounded-2xl shadow-xl hover:shadow-purple-500/40 transition cursor-pointer" onclick="loadTool('mods')">
        <div class="text-6xl mb-4">üõ°Ô∏è</div>
        <h2 class="text-2xl font-bold mb-2">Moderatoren</h2>
        <p class="text-purple-300">Mod-Liste mit seit wann</p>
      </div>
      <div class="bg-twitch-dark p-8 rounded-2xl shadow-xl hover:shadow-purple-500/40 transition cursor-pointer" onclick="loadTool('vips')">
        <div class="text-6xl mb-4">‚≠ê</div>
        <h2 class="text-2xl font-bold mb-2">VIPs</h2>
        <p class="text-purple-300">VIP-Liste mit seit wann</p>
      </div>
      <div class="bg-twitch-dark p-8 rounded-2xl shadow-xl hover:shadow-purple-500/40 transition cursor-pointer" onclick="loadTool('founders')">
        <div class="text-6xl mb-4">üëë</div>
        <h2 class="text-2xl font-bold mb-2">Founders</h2>
        <p class="text-purple-300">Gr√ºndungs-Mitglieder mit Datum</p>
      </div>
    </div>

    <!-- Tool Page -->
    <div id="toolPage" class="hidden">
      <button onclick="backToMain()" class="mb-8 px-6 py-3 bg-twitch-purple rounded-xl hover:bg-purple-700 transition">
        ‚Üê Zur√ºck zur √úbersicht
      </button>

      <h2 id="toolTitle" class="text-4xl font-bold mb-8"></h2>

      <div class="flex flex-col lg:flex-row gap-4 mb-8">
        <input id="usernameInput" type="text" placeholder="z.B. shroud oder xqc" class="flex-1 px-6 py-4 bg-twitch-darker border border-purple-600 rounded-xl focus:outline-none focus:border-twitch-purple text-lg">
        <button onclick="fetchData()" class="px-12 py-4 bg-twitch-purple rounded-xl hover:bg-purple-700 transition font-bold text-lg">Laden</button>
      </div>

      <input id="searchFilter" type="text" placeholder="In Ergebnissen suchen..." class="w-full px-6 py-3 mb-8 bg-twitch-darker border border-purple-600 rounded-xl focus:outline-none focus:border-twitch-purple hidden">

      <div id="loading" class="text-center text-purple-300 text-xl hidden">Lade Daten...</div>
      <div id="error" class="text-red-500 text-center text-xl hidden"></div>
      <div id="results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://twatch-62vd.onrender.com'; // ‚Üê Deine Backend-URL

    // Dark/Light Toggle
    document.getElementById('theme-toggle').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      document.getElementById('theme-toggle').textContent = document.documentElement.classList.contains('dark') ? 'Light Mode' : 'Dark Mode';
    });

    function loadTool(tool) {
      document.getElementById('mainTools').style.display = 'none';
      document.getElementById('toolPage').style.display = 'block';
      document.getElementById('toolTitle').textContent = {
        follows: 'Twitch Follows',
        mods: 'Moderatoren',
        vips: 'VIPs',
        founders: 'Founders'
      }[tool];
      window.currentTool = tool;
      document.getElementById('searchFilter').classList.remove('hidden');
      document.getElementById('searchFilter').value = '';
      document.getElementById('results').innerHTML = '';
    }

    function backToMain() {
      document.getElementById('toolPage').style.display = 'none';
      document.getElementById('mainTools').style.display = 'grid';
    }

    async function fetchData() {
      const username = document.getElementById('usernameInput').value.trim().toLowerCase();
      if (!username) {
        document.getElementById('error').textContent = 'Bitte Username eingeben.';
        document.getElementById('error').style.display = 'block';
        return;
      }

      const loading = document.getElementById('loading');
      const errorDiv = document.getElementById('error');
      const results = document.getElementById('results');

      loading.style.display = 'block';
      errorDiv.style.display = 'none';
      results.innerHTML = '';

      try {
        // Hole aktuelle Hashes vom Backend
        const hashRes = await fetch(`${API_BASE}/api/hashes`);
        if (!hashRes.ok) throw new Error(`Backend-Fehler: ${hashRes.status}`);
        const hashes = await hashRes.json();

        let data = [];
        if (window.currentTool === 'follows') {
          data = await fetchFollows(username, hashes);
        } else {
          // Hole User-ID vom Backend
          const userRes = await fetch(`${API_BASE}/api/userid`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ login: username })
          });
          if (!userRes.ok) throw new Error(`User-ID Fehler: ${userRes.status} - ${userRes.statusText}`);
          const userData = await userRes.json();
          if (!userData.userId) throw new Error('User nicht gefunden');

          data = await fetchList(window.currentTool, userData.userId, hashes);
        }

        renderResults(data);
      } catch (err) {
        errorDiv.textContent = 'Fehler: ' + err.message;
        errorDiv.style.display = 'block';
      } finally {
        loading.style.display = 'none';
      }
    }

    // Follows (nutzt Hash aus Backend)
    async function fetchFollows(login, hashes) {
      let all = [];
      let cursor = null;
      do {
        const query = {
          operationName: "Followers",
          variables: { limit: 100, login, order: "DESC", after: cursor },
          extensions: { persistedQuery: { version: 1, sha256Hash: hashes.followersHash || "3316194bb52051e2f9184012f6171b9aed4d457994568f1b4ed4a11e37a18b5c" } }
        };

        const res = await fetch('https://gql.twitch.tv/gql', {
          method: 'POST',
          headers: { 'Client-Id': 'kimne78kx3ncx6brgo4mv6wki5h1ko', 'Content-Type': 'application/json' },
          body: JSON.stringify([query])
        });
        if (!res.ok) throw new Error('Netzwerkfehler');
        const json = await res.json();
        const edges = json[0]?.data?.user?.followers?.edges || [];
        all.push(...edges.map(e => ({
          login: e.node.login,
          displayName: e.node.displayName,
          profileImage: e.node.profileImageURL || `https://ui-avatars.com/api/?name=${e.node.displayName}&background=9146ff&color=fff&size=128`,
          followedAt: e.node.followedAt ? new Date(e.node.followedAt).toLocaleDateString('de-DE') : 'N/A'
        })));
        cursor = json[0]?.data?.user?.followers?.pageInfo?.endCursor;
      } while (cursor);
      return all;
    }

    // Mods / VIPs / Founders (nutzt Hash aus Backend)
    async function fetchList(tool, userId, hashes) {
      const opMap = {
        mods: { name: "ModerationModerators", hash: hashes.moderationModerators },
        vips: { name: "ChannelVIPs", hash: hashes.channelVIPs },
        founders: { name: "ChannelFounders", hash: hashes.channelFounders }
      };
      const op = opMap[tool];

      const query = {
        operationName: op.name,
        variables: { broadcasterID: userId, limit: 100 },
        extensions: { persistedQuery: { version: 1, sha256Hash: op.hash } }
      };

      const res = await fetch('https://gql.twitch.tv/gql', {
        method: 'POST',
        headers: { 'Client-Id': 'kimne78kx3ncx6brgo4mv6wki5h1ko', 'Content-Type': 'application/json' },
        body: JSON.stringify([query])
      });
      if (!res.ok) throw new Error('Netzwerkfehler');
      const json = await res.json();

      const edges = json[0]?.data?.user?.[tool === 'mods' ? 'moderationModerators' : tool]?.edges || [];
      return edges.map(e => {
        const node = e.node;
        return {
          login: node.login,
          displayName: node.displayName,
          profileImage: node.profileImageURL || `https://ui-avatars.com/api/?name=${node.displayName}&background=9146ff&color=fff&size=128`,
          date: (node.grantedAt || node.subscribedAt || node.followedAt) ? new Date(node.grantedAt || node.subscribedAt || node.followedAt).toLocaleDateString('de-DE') : 'N/A'
        };
      });
    }

    function renderResults(data) {
      const container = document.getElementById('results');
      container.innerHTML = data.length === 0 ? '<p class="text-center text-purple-300 text-xl">Keine Eintr√§ge gefunden</p>' : '';
      data.forEach(item => {
        const card = document.createElement('div');
        card.className = 'bg-twitch-dark p-6 rounded-xl shadow-lg hover:shadow-purple-500/30 transition';
        card.innerHTML = `
          <div class="flex items-center gap-4">
            <img src="${item.profileImage}" alt="${item.displayName}" class="w-16 h-16 rounded-full border-2 border-twitch-purple">
            <div>
              <a href="https://twitch.tv/${item.login}" target="_blank" class="text-xl font-bold hover:text-twitch-purple transition">${item.displayName}</a>
              <p class="text-purple-300">@${item.login}</p>
              <p class="text-sm text-gray-400">${window.currentTool === 'follows' ? 'Folgt seit' : 'Seit'}: ${item.date}</p>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    document.getElementById('searchFilter').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const items = document.querySelectorAll('#results > div');
      items.forEach(item => {
        item.style.display = item.textContent.toLowerCase().includes(term) ? 'block' : 'none';
      });
    });
  </script>
</body>
</html>
</body>
</html>

